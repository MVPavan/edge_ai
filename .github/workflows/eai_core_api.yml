name: EAI-CORE-API

on:
  push:
    branches: [ "dev" ]
    paths: 
      - "eai_core_api/**"
  
  pull_request:
    branches: [ "dev" ]
    paths: 
      - "eai_core_api/**"

permissions:
  contents: read
  packages: write

jobs:
  build-core-api:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: eai_core_api
    env:
      poetry_venv_path: ~/.virtualenvs

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"

    - name: Cache Poetry virtualenv
      uses: actions/cache@v1
      id: cache
      with:
        path: $env.poetry_venv_path
        key: poetry-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          poetry-${{ hashFiles('**/poetry.lock') }}

    - uses: snok/install-poetry@v1
      with:
        version: 1.5.1
        virtualenvs-create: true
        virtualenvs-in-project: false
        virtualenvs-path: $env.poetry_venv_path

    - name: Install dependencies
      run: |
        poetry install
        if: steps.cache.outputs.cache-hit != 'true'
  
    - name: Code Quality
      run: poetry run black . --check

    - name: Set up Docker Compose
      uses: isbang/compose-action@v1.4.1
      with:
        compose-file: |
          ./eai_core_api/docker/compose.edgeai_db.yml

    - name: Run server
      run: |
        cd eai_core_api
        poetry run python3 main.py

    - name: Pytest
      run: |  
        poetry run pytest


  docker-publish-core-api:
    needs: build-core-api
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: eai_core_api

    steps:
    - uses: actions/checkout@v3
      
    - name: Build the Docker image
      run: |
        repo_name=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        docker build . --file docker/core_api.Dockerfile --tag ghcr.io/$repo_name/eai_core_api:v1.0.0

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push Docker image
      run: |
        repo_name=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        docker push ghcr.io/$repo_name/eai_core_api:v1.0.0
      # docker push ghcr.io/$repo_name/eai_core_api:$(date +%s)


